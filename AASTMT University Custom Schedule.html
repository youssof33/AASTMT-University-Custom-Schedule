<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>University Schedule Builder (Doctor Preferences)</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 20px; }
    h1, h2, h3 { text-align: center; color: #2c3e50; }
    .box { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: 600; color: #34495e; }
    input, select, button { margin-top: 5px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    button { background: #3498db; color: white; border: none; cursor: pointer; font-weight: 600; transition: background 0.3s; }
    button:hover { background: #2980b9; }
    .subject-item { padding: 10px 15px; margin: 8px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid; }
    .remove-btn { background: #e74c3c; padding: 5px 12px; font-size: 12px; color: white; border: none; border-radius: 3px; cursor: pointer; }
    .remove-btn:hover { background: #c0392b; }
    .group-controls { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; }
    
    /* Control Panel */
    .control-panel { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 15px; background: #2c3e50; border-radius: 10px; }
    .control-panel button { flex: 1; min-width: 150px; }
    .control-panel .reset-btn { background: #e74c3c; }
    .control-panel .reset-btn:hover { background: #c0392b; }
    .control-panel .save-btn { background: #2ecc71; }
    .control-panel .save-btn:hover { background: #27ae60; }
    .control-panel .export-btn { background: #f39c12; }
    .control-panel .export-btn:hover { background: #d68910; }
    .control-panel .import-btn { background: #9b59b6; }
    .control-panel .import-btn:hover { background: #8e44ad; }
    .file-input { display: none; }
    
    /* Schedule Table Styles */
    .schedule-table-container { overflow-x: auto; margin-top: 20px; }
    .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .schedule-table th, .schedule-table td { border: 1px solid #ddd; padding: 10px; text-align: center; vertical-align: top; }
    .schedule-table th { background: #2c3e50; color: white; font-weight: 600; position: sticky; top: 0; }
    .day-header { background: #34495e !important; }
    .time-header { background: #3498db !important; font-size: 12px; }
    .time-cell { background: #f8f9fa; font-size: 12px; color: #7f8c8d; padding: 5px !important; }
    .empty-cell { background: #f8f9fa; min-height: 60px; }
    .class-box { padding: 8px; margin: 3px; border-radius: 4px; font-size: 12px; position: relative; }
    .class-subject { font-weight: bold; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-bottom: 3px; }
    .class-doctor { font-style: italic; font-size: 11px; }
    .class-type { font-size: 10px; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-top: 3px; font-weight: 600; }
    .class-group { font-size: 10px; padding: 2px 5px; border-radius: 3px; background: rgba(0,0,0,0.1); margin-top: 3px; display: inline-block; }
    
    /* Results Section */
    .result-schedule { margin-bottom: 30px; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    /* Form Controls */
    .class-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .form-group { display: flex; flex-direction: column; }
    
    /* Preference Section */
    .preference-box { margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .pref-type-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px; }
    .pref-type { background: white; padding: 15px; border-radius: 6px; border: 1px solid #e0e0e0; }
    
    /* Notification */
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #2ecc71; color: white; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; display: none; }
    .notification.error { background: #e74c3c; }
  </style>
</head>
<body>

<!-- Control Panel -->
<div class="control-panel">
  <button class="save-btn" onclick="saveToBrowser()">üíæ Save to Browser</button>
  <button class="export-btn" onclick="exportData()">üì§ Export JSON</button>
  <button class="import-btn" onclick="document.getElementById('importFile').click()">üì• Import JSON</button>
  <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
  <button class="reset-btn" onclick="resetAll()">üîÑ Reset All</button>
</div>

<!-- Notification -->
<div id="notification" class="notification"></div>

<h1>University Schedule Builder</h1>

<!-- SUBJECTS -->
<div class="box">
  <h2>1) Subjects</h2>
  <div style="display: flex; gap: 10px;">
    <input id="subjectName" placeholder="Enter subject name" style="flex-grow: 1;">
    <button onclick="addSubject()">Add Subject</button>
  </div>
  <div id="subjectList" style="margin-top: 15px;"></div>
</div>

<!-- GROUPS -->
<div class="box">
  <h2>2) University Groups</h2>
  <div class="group-controls">
    <button onclick="addGroup()">‚ûï Add New Group</button>
    <select id="groupSelector" onchange="selectGroup(this.value)" style="padding: 10px; min-width: 200px;">
      <option value="">Select Group to Edit</option>
    </select>
  </div>
  
  <div id="currentGroupInfo" style="display: none; margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 8px;">
    <h3 style="margin: 0; color: #2c3e50;">Editing: <span id="groupNameDisplay" style="color: #3498db;"></span></h3>
  </div>
  
  <div id="groupScheduleEditor" style="display: none;">
    <!-- Class Form -->
    <div class="class-form">
      <div class="form-group">
        <label>Subject:</label>
        <select id="classSubject">
          <option value="">Select Subject</option>
        </select>
      </div>
      <div class="form-group">
        <label>Type:</label>
        <select id="classType" onchange="updateInstructorOptions()">
          <option value="Lecture">Lecture</option>
          <option value="Section">Section</option>
          <option value="Lab">Lab</option>
        </select>
      </div>
      <div class="form-group">
        <label>Instructor Name:</label>
        <input id="className" placeholder="Enter name">
        <div id="instructorHelp" style="font-size: 11px; color: #7f8c8d; margin-top: 3px;"></div>
      </div>
      <div class="form-group">
        <label>Day:</label>
        <select id="classDay">
          <option value="Saturday">Saturday</option>
          <option value="Sunday">Sunday</option>
          <option value="Monday">Monday</option>
          <option value="Tuesday">Tuesday</option>
          <option value="Wednesday">Wednesday</option>
          <option value="Thursday">Thursday</option>
          <option value="Friday">Friday</option>
        </select>
      </div>
      <div class="form-group">
        <label>Time Slot:</label>
        <select id="classTime">
          <option value="0">Lecture 1 (8:30 AM - 10:00 AM)</option>
          <option value="1">Lecture 2 (10:30 AM - 12:00 PM)</option>
          <option value="2">Lecture 3 (12:30 PM - 2:00 PM)</option>
          <option value="3">Lecture 4 (2:30 PM - 4:00 PM)</option>
          <option value="4">Lecture 5 (4:30 PM - 6:00 PM)</option>
          <option value="5">Lecture 6 (6:30 PM - 8:00 PM)</option>
        </select>
      </div>
      <div class="form-group" style="justify-content: flex-end;">
        <button onclick="addClassToGroup()" style="height: 40px; margin-top: 25px;">Add to Schedule</button>
      </div>
    </div>
    
    <!-- Schedule Table -->
    <div class="schedule-table-container">
      <table class="schedule-table">
        <thead>
          <tr>
            <th class="day-header">Day</th>
            <th class="time-header">Lecture 1<br><small>8:30-10:00</small></th>
            <th class="time-header">Lecture 2<br><small>10:30-12:00</small></th>
            <th class="time-header">Lecture 3<br><small>12:30-2:00</small></th>
            <th class="time-header">Lecture 4<br><small>2:30-4:00</small></th>
            <th class="time-header">Lecture 5<br><small>4:30-6:00</small></th>
            <th class="time-header">Lecture 6<br><small>6:30-8:00</small></th>
          </tr>
        </thead>
        <tbody id="scheduleGrid">
          <!-- Days will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- PREFERENCES -->
<div class="box">
  <h2>3) Doctor / TA Preferences</h2>
  <div id="preferences"></div>
</div>

<!-- GENERATE -->
<div class="box">
  <h2>4) Generate Schedule</h2>
  <button onclick="generateSchedules()" style="padding: 12px 25px; font-size: 16px;">Generate All Possible Schedules</button>
  
  <div id="results" style="margin-top: 30px;">
    <div id="scheduleResults"></div>
  </div>
</div>

<script>
let subjects = [];
let groups = [];
let currentEditingGroup = null;
let currentScheduleIndex = 0;
let allSchedules = [];

// Softer pastel colors for subjects
const subjectColors = [
  { base: '#FFB3BA', lecture: '#FF8BA0', section: '#FFCED4', lab: '#FFE6E9', dark: '#FF6B7A' }, // Soft Red/Pink
  { base: '#BAFFC9', lecture: '#8BFFA3', section: '#CEFFD8', lab: '#E6FFEC', dark: '#6BFF8A' }, // Soft Green
  { base: '#BAE1FF', lecture: '#8BCAFF', section: '#CEE7FF', lab: '#E6F3FF', dark: '#6BB5FF' }, // Soft Blue
  { base: '#FFFFBA', lecture: '#FFFF8B', section: '#FFFFCE', lab: '#FFFFE6', dark: '#FFFF6B' }, // Soft Yellow
  { base: '#D0BAFF', lecture: '#B38BFF', section: '#E1CEFF', lab: '#F0E6FF', dark: '#9E6BFF' }, // Soft Purple
  { base: '#FFDFBA', lecture: '#FFCA8B', section: '#FFECCE', lab: '#FFF6E6', dark: '#FFB16B' }, // Soft Orange
  { base: '#BAFFF1', lecture: '#8BFFE6', section: '#CEFFF8', lab: '#E6FFFC', dark: '#6BFFE0' }, // Soft Teal
  { base: '#FFBAF1', lecture: '#FF8BE6', section: '#FFCEF8', lab: '#FFE6FC', dark: '#FF6BE0' }, // Soft Pink
  { base: '#D4FFBA', lecture: '#B8FF8B', section: '#E5FFCE', lab: '#F2FFE6', dark: '#A2FF6B' }, // Soft Lime
  { base: '#BAB3FF', lecture: '#8B80FF', section: '#CEC9FF', lab: '#E6E4FF', dark: '#6B5EFF' }  // Soft Lavender
];

// Fixed lecture times
const lectureTimes = [
  { label: "Lecture 1", start: 8.5, end: 10, timeStr: "8:30 AM - 10:00 AM" },
  { label: "Lecture 2", start: 10.5, end: 12, timeStr: "10:30 AM - 12:00 PM" },
  { label: "Lecture 3", start: 12.5, end: 14, timeStr: "12:30 PM - 2:00 PM" },
  { label: "Lecture 4", start: 14.5, end: 16, timeStr: "2:30 PM - 4:00 PM" },
  { label: "Lecture 5", start: 16.5, end: 18, timeStr: "4:30 PM - 6:00 PM" },
  { label: "Lecture 6", start: 18.5, end: 20, timeStr: "6:30 PM - 8:00 PM" }
];

const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

/******** SAVE/LOAD FUNCTIONALITY ********/
function showNotification(message, isError = false) {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = isError ? 'notification error' : 'notification';
  notification.style.display = 'block';
  
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

function saveToBrowser() {
  try {
    const data = {
      subjects: subjects,
      groups: groups,
      preferences: getCurrentPreferences(),
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('universityScheduleData', JSON.stringify(data));
    showNotification('‚úÖ Data saved to browser successfully!');
  } catch (error) {
    showNotification('‚ùå Error saving data to browser', true);
  }
}

function loadFromBrowser() {
  try {
    const saved = localStorage.getItem('universityScheduleData');
    if (saved) {
      const data = JSON.parse(saved);
      
      subjects = data.subjects || [];
      groups = data.groups || [];
      
      // Make sure all classes have groupName property (for backward compatibility)
      groups.forEach(group => {
        group.classes.forEach(cls => {
          if (!cls.groupName) {
            cls.groupName = group.name;
          }
        });
      });
      
      renderSubjects();
      updateClassSubjectDropdown();
      updateGroupSelector();
      renderPreferences();
      
      // Load preferences after rendering
      if (data.preferences) {
        setTimeout(() => loadPreferences(data.preferences), 100);
      }
      
      showNotification('üìÇ Data loaded from browser');
    }
  } catch (error) {
    console.error('Error loading from browser:', error);
  }
}

function getCurrentPreferences() {
  const preferences = {};
  subjects.forEach(s => {
    const lectureElem = document.getElementById(`pref_${s}_Lecture`);
    const sectionElem = document.getElementById(`pref_${s}_Section`);
    const labElem = document.getElementById(`pref_${s}_Lab`);
    
    if (lectureElem && sectionElem && labElem) {
      preferences[s] = {
        Lecture: lectureElem.value,
        Section: sectionElem.value,
        Lab: labElem.value
      };
    }
  });
  return preferences;
}

function loadPreferences(preferences) {
  for (const subject in preferences) {
    const lectureElem = document.getElementById(`pref_${subject}_Lecture`);
    const sectionElem = document.getElementById(`pref_${subject}_Section`);
    const labElem = document.getElementById(`pref_${subject}_Lab`);
    
    if (lectureElem) lectureElem.value = preferences[subject].Lecture || 'Any';
    if (sectionElem) sectionElem.value = preferences[subject].Section || 'Any';
    if (labElem) labElem.value = preferences[subject].Lab || 'Any';
  }
}

function exportData() {
  try {
    const data = {
      subjects: subjects,
      groups: groups,
      preferences: getCurrentPreferences(),
      timestamp: new Date().toISOString(),
      version: '1.0'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `university-schedule-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('üì§ Data exported successfully!');
  } catch (error) {
    showNotification('‚ùå Error exporting data', true);
  }
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      if (!data.subjects || !data.groups) {
        throw new Error('Invalid file format');
      }
      
      subjects = data.subjects;
      groups = data.groups;
      
      // Reset file input
      event.target.value = '';
      
      renderSubjects();
      updateClassSubjectDropdown();
      updateGroupSelector();
      renderPreferences();
      
      // Load preferences after rendering
      if (data.preferences) {
        setTimeout(() => loadPreferences(data.preferences), 100);
      }
      
      if (currentEditingGroup) {
        renderScheduleTable(currentEditingGroup);
      }
      
      showNotification('üì• Data imported successfully!');
    } catch (error) {
      showNotification('‚ùå Error importing data. Invalid file format.', true);
    }
  };
  reader.readAsText(file);
}

function resetAll() {
  if (!confirm('‚ö†Ô∏è Are you sure you want to reset everything? This action cannot be undone.')) {
    return;
  }
  
  subjects = [];
  groups = [];
  currentEditingGroup = null;
  allSchedules = [];
  
  // Clear local storage
  localStorage.removeItem('universityScheduleData');
  
  // Clear UI
  renderSubjects();
  updateClassSubjectDropdown();
  updateGroupSelector();
  renderPreferences();
  
  // Hide schedule editor
  document.getElementById('currentGroupInfo').style.display = 'none';
  document.getElementById('groupScheduleEditor').style.display = 'none';
  
  // Clear results
  document.getElementById('scheduleResults').innerHTML = '';
  document.getElementById('results').innerHTML = '<div id="scheduleResults"></div>';
  
  // Clear form fields
  document.getElementById('subjectName').value = '';
  document.getElementById('className').value = '';
  
  showNotification('üîÑ All data has been reset');
}

// Auto-save when making changes
function autoSave() {
  if (localStorage.getItem('universityScheduleData')) {
    saveToBrowser();
  }
}

/******** SUBJECTS ********/
function getSubjectColor(subject, type = 'base') {
  const index = subjects.indexOf(subject);
  if (index === -1 || index >= subjectColors.length) {
    const defaults = { base: '#E2E8F0', lecture: '#CBD5E1', section: '#F1F5F9', lab: '#F8FAFC', dark: '#94A3B8' };
    return defaults[type] || defaults.base;
  }
  return subjectColors[index][type] || subjectColors[index].base;
}

function addSubject() {
  const name = document.getElementById('subjectName').value.trim();
  if (!name) {
    alert("Please enter a subject name");
    return;
  }
  if (subjects.includes(name)) {
    alert("Subject already exists");
    return;
  }
  
  subjects.push(name);
  document.getElementById('subjectName').value = '';
  renderSubjects();
  updateClassSubjectDropdown();
  renderPreferences();
  autoSave();
}

function removeSubject(s) {
  if (!confirm(`Remove subject "${s}"? This will also remove all classes for this subject.`)) return;
  
  subjects = subjects.filter(x => x !== s);
  groups.forEach(g => {
    g.classes = g.classes.filter(c => c.subject !== s);
  });
  renderSubjects();
  updateClassSubjectDropdown();
  renderPreferences();
  if (currentEditingGroup) {
    renderScheduleTable(currentEditingGroup);
  }
  autoSave();
}

function renderSubjects() {
  const container = document.getElementById('subjectList');
  container.innerHTML = '';
  
  if (subjects.length === 0) {
    container.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">No subjects added yet.</p>';
    return;
  }
  
  subjects.forEach(s => {
    const color = getSubjectColor(s, 'dark');
    const bgColor = getSubjectColor(s, 'base');
    const div = document.createElement('div');
    div.className = 'subject-item';
    div.style.background = bgColor;
    div.style.borderLeftColor = color;
    div.innerHTML = `
      <span style="font-weight:600; color:#2c3e50;">${s}</span>
      <button class="remove-btn" onclick="removeSubject('${s}')">Remove</button>
    `;
    container.appendChild(div);
  });
}

/******** GROUPS ********/
function addGroup() {
  const groupId = groups.length + 1;
  const groupName = `Group ${groupId}`;
  
  groups.push({
    id: groupId,
    name: groupName,
    classes: []
  });
  
  updateGroupSelector();
  selectGroup(groupId - 1);
  autoSave();
}

function updateGroupSelector() {
  const selector = document.getElementById('groupSelector');
  selector.innerHTML = '<option value="">Select Group to Edit</option>';
  
  groups.forEach((g, i) => {
    selector.innerHTML += `<option value="${i}">${g.name}</option>`;
  });
}

function selectGroup(index) {
  if (index === "") {
    document.getElementById('currentGroupInfo').style.display = 'none';
    document.getElementById('groupScheduleEditor').style.display = 'none';
    currentEditingGroup = null;
    return;
  }
  
  currentEditingGroup = groups[index];
  document.getElementById('currentGroupInfo').style.display = 'block';
  document.getElementById('groupScheduleEditor').style.display = 'block';
  document.getElementById('groupNameDisplay').textContent = currentEditingGroup.name;
  
  renderScheduleTable(currentEditingGroup);
  updateInstructorOptions();
}

function updateClassSubjectDropdown() {
  const dropdown = document.getElementById('classSubject');
  dropdown.innerHTML = '<option value="">Select Subject</option>';
  
  subjects.forEach(s => {
    dropdown.innerHTML += `<option value="${s}">${s}</option>`;
  });
}

function updateInstructorOptions() {
  const type = document.getElementById('classType').value;
  const helpText = document.getElementById('instructorHelp');
  
  if (type === 'Lecture') {
    helpText.textContent = 'Enter doctor name for lecture';
  } else if (type === 'Section') {
    helpText.textContent = 'Enter TA name for section';
  } else {
    helpText.textContent = 'Enter TA name for lab';
  }
}

function addClassToGroup() {
  if (!currentEditingGroup) {
    alert("Please select a group first");
    return;
  }
  
  const subject = document.getElementById('classSubject').value;
  const type = document.getElementById('classType').value;
  const name = document.getElementById('className').value.trim();
  const day = document.getElementById('classDay').value;
  const timeSlot = parseInt(document.getElementById('classTime').value);
  
  if (!subject) {
    alert("Please select a subject");
    return;
  }
  if (!name) {
    alert("Please enter instructor name");
    return;
  }
  
  const timeData = lectureTimes[timeSlot];
  const startTime = timeData.start * 60;
  const endTime = timeData.end * 60;
  
  // Check for time conflicts
  const conflict = currentEditingGroup.classes.find(c => 
    c.day === day && 
    c.timeSlot === timeSlot
  );
  
  if (conflict) {
    if (!confirm(`There's already a class in this time slot. Replace it?`)) return;
    currentEditingGroup.classes = currentEditingGroup.classes.filter(c => 
      !(c.day === day && c.timeSlot === timeSlot)
    );
  }
  
  currentEditingGroup.classes.push({
    subject,
    type,
    name,
    day,
    timeSlot,
    start: startTime,
    end: endTime,
    groupName: currentEditingGroup.name  // Store group name with the class
  });
  
  // Clear form
  document.getElementById('className').value = '';
  
  renderScheduleTable(currentEditingGroup);
  renderPreferences();
  autoSave();
}

function removeClassFromGroup(day, timeSlot) {
  if (!currentEditingGroup) return;
  
  currentEditingGroup.classes = currentEditingGroup.classes.filter(c => 
    !(c.day === day && c.timeSlot === timeSlot)
  );
  
  renderScheduleTable(currentEditingGroup);
  renderPreferences();
  autoSave();
}

function renderScheduleTable(group) {
  const tbody = document.getElementById('scheduleGrid');
  tbody.innerHTML = '';
  
  // Create rows for each day
  days.forEach(day => {
    const row = document.createElement('tr');
    
    // Day cell - first column
    const dayCell = document.createElement('td');
    dayCell.className = 'day-header';
    dayCell.textContent = day;
    dayCell.style.fontWeight = '600';
    row.appendChild(dayCell);
    
    // Create cells for each lecture slot (6 columns)
    for (let timeIndex = 0; timeIndex < 6; timeIndex++) {
      const cell = document.createElement('td');
      cell.className = 'empty-cell';
      
      // Find class for this day and time slot
      const classItem = group.classes.find(c => 
        c.day === day && c.timeSlot === timeIndex
      );
      
      if (classItem) {
        // Get colors based on subject and type
        const bgColor = getSubjectColor(classItem.subject, classItem.type.toLowerCase());
        const darkColor = getSubjectColor(classItem.subject, 'dark');
        const typeColor = getSubjectColor(classItem.subject, 'lecture');
        
        const classBox = document.createElement('div');
        classBox.className = 'class-box';
        classBox.style.background = bgColor;
        classBox.style.borderLeft = `3px solid ${darkColor}`;
        classBox.innerHTML = `
          <div class="class-subject" style="background:${darkColor}; color:white;">${classItem.subject}</div>
          <div class="class-doctor" style="color:${darkColor};">${classItem.name}</div>
          <div class="class-type" style="background:${typeColor}; color:white;">${classItem.type}</div>
          <button class="remove-btn" onclick="removeClassFromGroup('${day}', ${timeIndex})" 
                  style="position:absolute; top:5px; right:5px; padding:2px 6px; font-size:10px;">‚úï</button>
        `;
        cell.appendChild(classBox);
      }
      
      row.appendChild(cell);
    }
    
    tbody.appendChild(row);
  });
}

/******** PREFERENCES ********/
function renderPreferences() {
  const div = document.getElementById('preferences');
  div.innerHTML = '';
  
  if (subjects.length === 0) {
    div.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">Add subjects first to set preferences.</p>';
    return;
  }
  
  subjects.forEach(s => {
    // Collect names separately by type for this subject
    const lectureNames = new Set();
    const sectionNames = new Set();
    const labNames = new Set();
    
    groups.forEach(g => {
      g.classes.filter(c => c.subject === s).forEach(c => {
        if (c.type === 'Lecture') {
          lectureNames.add(c.name);
        } else if (c.type === 'Section') {
          sectionNames.add(c.name);
        } else if (c.type === 'Lab') {
          labNames.add(c.name);
        }
      });
    });
    
    const color = getSubjectColor(s, 'dark');
    const bgColor = getSubjectColor(s, 'base');
    
    const prefBox = document.createElement('div');
    prefBox.className = 'preference-box';
    prefBox.style.borderLeft = `4px solid ${color}`;
    prefBox.style.background = bgColor;
    prefBox.innerHTML = `
      <h4 style="margin-top:0; color:${color}; padding-bottom: 10px; border-bottom: 2px solid rgba(0,0,0,0.1);">
        ${s}
      </h4>
      <div class="pref-type-container">
        <div class="pref-type">
          <label>Preferred Lecture Doctor:</label>
          <select id="pref_${s}_Lecture" style="width:100%" onchange="autoSave()">
            <option value="Any">Any doctor</option>
            ${Array.from(lectureNames).map(n => `<option value="${n}">Dr. ${n}</option>`).join('')}
          </select>
          <div style="font-size:11px; color:#7f8c8d; margin-top:5px;">
            ${lectureNames.size} doctor${lectureNames.size !== 1 ? 's' : ''} available
          </div>
        </div>
        <div class="pref-type">
          <label>Preferred Section TA:</label>
          <select id="pref_${s}_Section" style="width:100%" onchange="autoSave()">
            <option value="Any">Any TA</option>
            ${Array.from(sectionNames).map(n => `<option value="${n}">TA ${n}</option>`).join('')}
          </select>
          <div style="font-size:11px; color:#7f8c8d; margin-top:5px;">
            ${sectionNames.size} TA${sectionNames.size !== 1 ? 's' : ''} available
          </div>
        </div>
        <div class="pref-type">
          <label>Preferred Lab TA:</label>
          <select id="pref_${s}_Lab" style="width:100%" onchange="autoSave()">
            <option value="Any">Any TA</option>
            ${Array.from(labNames).map(n => `<option value="${n}">TA ${n}</option>`).join('')}
          </select>
          <div style="font-size:11px; color:#7f8c8d; margin-top:5px;">
            ${labNames.size} TA${labNames.size !== 1 ? 's' : ''} available
          </div>
        </div>
      </div>
    `;
    div.appendChild(prefBox);
  });
}

/******** SCHEDULE GENERATION ********/
function toMin(t) { 
  if (!t) return 0; 
  if (typeof t === 'number') return t;
  let [h, m] = t.split(':'); 
  return parseInt(h) * 60 + parseInt(m || 0); 
}

function fromMin(m) { 
  const hours = Math.floor(m / 60);
  const minutes = m % 60;
  const ampm = hours >= 12 ? 'PM' : 'AM';
  const displayHours = hours % 12 || 12;
  return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
}

function clash(a, b) { 
  return a.day === b.day && !(a.end <= b.start || b.end <= a.start); 
}

function generateSchedules() {
  if (subjects.length === 0) {
    alert("Please add subjects first");
    return;
  }
  
  if (groups.length === 0) {
    alert("Please add at least one group");
    return;
  }
  
  // Collect all possible class combinations per subject
  let options = {};
  subjects.forEach(s => options[s] = []);
  
  groups.forEach(g => {
    subjects.forEach(s => {
      let pack = g.classes.filter(c => c.subject === s);
      if (!pack.length) return;
      
      let ok = true;
      pack.forEach(c => {
        let pref = document.getElementById(`pref_${s}_${c.type}`)?.value || 'Any';
        if (pref !== 'Any' && pref !== c.name) ok = false;
      });
      if (ok) options[s].push({pack: pack, group: g.name});
    });
  });
  
  // Check if any subject has no options
  for (let subject in options) {
    if (options[subject].length === 0) {
      alert(`No valid classes found for "${subject}" based on preferences.`);
      return;
    }
  }
  
  allSchedules = [];
  let subjectList = Object.keys(options);
  
  function backtrack(index, current, groupsUsed) {
    if (index === subjectList.length) {
      allSchedules.push({
        classes: current.flat(),
        groups: [...groupsUsed]
      });
      return;
    }
    
    const subject = subjectList[index];
    for (let option of options[subject]) {
      let valid = true;
      
      // Check for time conflicts
      for (let newClass of option.pack) {
        for (let existingClass of current.flat()) {
          if (clash(newClass, existingClass)) {
            valid = false;
            break;
          }
        }
        if (!valid) break;
      }
      
      if (valid) {
        // Add group name to each class in the pack
        const packWithGroup = option.pack.map(cls => ({
          ...cls,
          groupName: option.group
        }));
        
        backtrack(index + 1, [...current, packWithGroup], [...groupsUsed, option.group]);
      }
    }
  }
  
  backtrack(0, [], []);
  displayAllSchedules();
}

function displayAllSchedules() {
  const resultsDiv = document.getElementById('results');
  const scheduleResults = document.getElementById('scheduleResults');
  
  if (!allSchedules.length) {
    scheduleResults.innerHTML = `
      <div class="box" style="text-align:center; padding:30px;">
        <h3 style="color:#e74c3c;">No Valid Schedules Found</h3>
        <p>Try adjusting your preferences or adding more classes to groups.</p>
      </div>
    `;
    return;
  }
  
  scheduleResults.innerHTML = '';
  
  // Show all schedules stacked
  allSchedules.forEach((scheduleData, index) => {
    const schedule = scheduleData.classes;
    const scheduleDiv = document.createElement('div');
    scheduleDiv.className = 'result-schedule';
    scheduleDiv.id = `schedule-${index}`;
    
    // Get unique groups used in this schedule
    const uniqueGroups = [...new Set(schedule.map(c => c.groupName))];
    
    const scheduleTitle = document.createElement('h3');
    scheduleTitle.innerHTML = `
      Schedule Option ${index + 1} 
      <small style="color:#7f8c8d; font-weight:normal;">
        (${schedule.length} classes from ${uniqueGroups.length} group${uniqueGroups.length !== 1 ? 's' : ''})
      </small>
    `;
    scheduleDiv.appendChild(scheduleTitle);
    
    // Create table for this schedule
    const tableContainer = document.createElement('div');
    tableContainer.className = 'schedule-table-container';
    
    const table = document.createElement('table');
    table.className = 'schedule-table';
    
    // Table header (simplified - no "Lectures" row)
    table.innerHTML = `
      <thead>
        <tr>
          <th class="day-header">Day</th>
          <th class="time-header">Lecture 1<br><small>8:30-10:00</small></th>
          <th class="time-header">Lecture 2<br><small>10:30-12:00</small></th>
          <th class="time-header">Lecture 3<br><small>12:30-2:00</small></th>
          <th class="time-header">Lecture 4<br><small>2:30-4:00</small></th>
          <th class="time-header">Lecture 5<br><small>4:30-6:00</small></th>
          <th class="time-header">Lecture 6<br><small>6:30-8:00</small></th>
        </tr>
      </thead>
      <tbody id="result-schedule-${index}">
      </tbody>
    `;
    
    const tbody = table.querySelector(`#result-schedule-${index}`);
    
    // Group classes by day
    const classesByDay = {};
    days.forEach(day => classesByDay[day] = Array(6).fill(null));
    
    schedule.forEach(cls => {
      classesByDay[cls.day][cls.timeSlot] = cls;
    });
    
    // Create rows for each day
    days.forEach(day => {
      const row = document.createElement('tr');
      
      // Day cell - first column
      const dayCell = document.createElement('td');
      dayCell.className = 'day-header';
      dayCell.textContent = day;
      dayCell.style.fontWeight = '600';
      row.appendChild(dayCell);
      
      // Cells for each lecture slot
      for (let i = 0; i < 6; i++) {
        const cell = document.createElement('td');
        cell.className = 'empty-cell';
        
        const cls = classesByDay[day][i];
        if (cls) {
          // Get colors based on subject and type
          const bgColor = getSubjectColor(cls.subject, cls.type.toLowerCase());
          const darkColor = getSubjectColor(cls.subject, 'dark');
          const typeColor = getSubjectColor(cls.subject, 'lecture');
          
          const classBox = document.createElement('div');
          classBox.className = 'class-box';
          classBox.style.background = bgColor;
          classBox.style.borderLeft = `3px solid ${darkColor}`;
          classBox.innerHTML = `
            <div class="class-subject" style="background:${darkColor}; color:white;">${cls.subject}</div>
            <div class="class-doctor" style="color:${darkColor};">${cls.name}</div>
            <div class="class-type" style="background:${typeColor}; color:white;">${cls.type}</div>
            <div class="class-group" style="color:${darkColor};">${cls.groupName}</div>
            <div style="font-size:10px; color:${darkColor}; margin-top:3px;">${fromMin(cls.start)}-${fromMin(cls.end)}</div>
          `;
          cell.appendChild(classBox);
        }
        
        row.appendChild(cell);
      }
      
      tbody.appendChild(row);
    });
    
    tableContainer.appendChild(table);
    scheduleDiv.appendChild(tableContainer);
    scheduleResults.appendChild(scheduleDiv);
  });
  
  // Add summary
  const summary = document.createElement('div');
  summary.className = 'box';
  summary.style.textAlign = 'center';
  summary.innerHTML = `
    <h3 style="color:#27ae60;">Found ${allSchedules.length} Possible Schedule${allSchedules.length !== 1 ? 's' : ''}</h3>
    <p>Each class shows which group it belongs to (e.g., "Group 1"). This helps you know which group to register for.</p>
    <p>Scroll down to see all schedule options stacked below.</p>
  `;
  scheduleResults.insertBefore(summary, scheduleResults.firstChild);
}

// Load data from browser when page loads
window.addEventListener('load', () => {
  loadFromBrowser();
});

// Initialize
updateClassSubjectDropdown();
renderSubjects();
</script>

</body>
</html>