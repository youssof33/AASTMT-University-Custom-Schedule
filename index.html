<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>University Schedule Builder (Doctor Preferences)</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 20px; }
    h1, h2, h3 { text-align: center; color: #2c3e50; }
    .box { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: 600; color: #34495e; }
    input, select, button { margin-top: 5px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    button { background: #3498db; color: white; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .subject-item { padding: 10px 15px; margin: 8px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid; }
    .remove-btn { background: #e74c3c; padding: 5px 12px; font-size: 12px; color: white; border: none; border-radius: 3px; cursor: pointer; }
    .remove-btn:hover { background: #c0392b; }
    .edit-btn { background: #9b59b6; padding: 5px 12px; font-size: 12px; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px; }
    .edit-btn:hover { background: #8e44ad; }
    .group-controls { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; }
    
    /* Control Panel - Redesigned */
    .control-panel { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
    .control-panel button { flex: 1; min-width: 180px; padding: 14px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; border-radius: 8px; border: none; backdrop-filter: blur(10px); background: rgba(255,255,255,0.2); transition: all 0.3s; }
    .control-panel button:hover { background: rgba(255,255,255,0.3); transform: translateY(-3px) scale(1.02); }
    .control-panel .reset-btn { background: rgba(231, 76, 60, 0.8); }
    .control-panel .reset-btn:hover { background: rgba(231, 76, 60, 0.9); }
    .control-panel .save-btn { background: rgba(46, 204, 113, 0.8); }
    .control-panel .save-btn:hover { background: rgba(46, 204, 113, 0.9); }
    .control-panel .export-btn { background: rgba(243, 156, 18, 0.8); }
    .control-panel .export-btn:hover { background: rgba(243, 156, 18, 0.9); }
    .control-panel .import-btn { background: rgba(155, 89, 182, 0.8); }
    .control-panel .import-btn:hover { background: rgba(155, 89, 182, 0.9); }
    .file-input { display: none; }
    
    /* Schedule Table Styles */
    .schedule-table-container { overflow-x: auto; margin-top: 20px; }
    .schedule-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .schedule-table th, .schedule-table td { border: 1px solid #ddd; padding: 10px; text-align: center; vertical-align: top; }
    .schedule-table th { background: #2c3e50; color: white; font-weight: 600; position: sticky; top: 0; }
    .day-header { background: #34495e !important; }
    .time-header { background: #3498db !important; font-size: 12px; }
    .time-cell { background: #f8f9fa; font-size: 12px; color: #7f8c8d; padding: 5px !important; }
    .empty-cell { background: #f8f9fa; min-height: 60px; }
    .class-box { padding: 8px; margin: 3px; border-radius: 4px; font-size: 12px; position: relative; }
    .class-subject { font-weight: bold; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-bottom: 3px; }
    .class-doctor { font-style: italic; font-size: 11px; padding: 2px 5px; border-radius: 3px; margin: 3px 0; }
    .class-type { font-size: 10px; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-top: 3px; font-weight: 600; }
    .class-group { font-size: 10px; padding: 2px 5px; border-radius: 3px; background: rgba(0,0,0,0.1); margin-top: 3px; display: inline-block; }
    .no-instructor { color: #e74c3c; font-size: 10px; font-style: normal; background: rgba(231, 76, 60, 0.1); padding: 2px 5px; border-radius: 3px; margin: 3px 0; }
    .edit-class-btn { background: #9b59b6; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-top: 3px; }
    .edit-class-btn:hover { background: #8e44ad; }
    
    /* Results Section */
    .result-schedule { margin-bottom: 30px; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    
    /* Form Controls */
    .class-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .form-group { display: flex; flex-direction: column; }
    
    /* Preference Section */
    .preference-box { margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; position: relative; }
    .subject-checkbox { position: absolute; top: 15px; right: 15px; }
    .pref-type-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px; }
    .pref-type { background: white; padding: 15px; border-radius: 6px; border: 1px solid #e0e0e0; }
    
    /* Notification */
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background: #2ecc71; color: white; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; display: none; }
    .notification.error { background: #e74c3c; }
    
    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
    .modal-content { background: white; margin: 10% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .close-modal { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
    
    /* Group Management */
    .group-management { display: flex; gap: 10px; margin-top: 15px; }
    
    /* Color Picker */
    .color-picker { display: flex; gap: 5px; margin-top: 10px; }
    .color-option { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
    .color-option.selected { border-color: #2c3e50; }
  </style>
</head>
<body>

<!-- Control Panel - Redesigned -->
<div class="control-panel">
  <button class="save-btn" onclick="saveToBrowser()">
    <span style="font-size: 18px;">üíæ</span> Save to Browser
  </button>
  <button class="export-btn" onclick="exportData()">
    <span style="font-size: 18px;">üì§</span> Export JSON
  </button>
  <button class="import-btn" onclick="document.getElementById('importFile').click()">
    <span style="font-size: 18px;">üì•</span> Import JSON
  </button>
  <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
  <button class="reset-btn" onclick="resetAll()">
    <span style="font-size: 18px;">üîÑ</span> Reset All
  </button>
</div>

<!-- Notification -->
<div id="notification" class="notification"></div>

<!-- Edit Instructor Modal -->
<div id="editInstructorModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin: 0;">Edit Class</h3>
      <button class="close-modal" onclick="closeEditModal()">‚úï</button>
    </div>
    <div id="modalBody">
      <!-- Content will be added here -->
    </div>
  </div>
</div>

<!-- Edit Subject Modal -->
<div id="editSubjectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin: 0;">Edit Subject</h3>
      <button class="close-modal" onclick="closeEditSubjectModal()">‚úï</button>
    </div>
    <div id="editSubjectBody">
      <!-- Content will be added here -->
    </div>
  </div>
</div>

<!-- Edit Group Modal -->
<div id="editGroupModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin: 0;">Edit Group</h3>
      <button class="close-modal" onclick="closeEditGroupModal()">‚úï</button>
    </div>
    <div id="editGroupBody">
      <!-- Content will be added here -->
    </div>
  </div>
</div>

<h1>University Schedule Builder</h1>

<!-- SUBJECTS -->
<div class="box">
  <h2>1) Subjects</h2>
  <div style="display: flex; gap: 10px;">
    <input id="subjectName" placeholder="Enter subject name" style="flex-grow: 1;">
    <button onclick="addSubject()">Add Subject</button>
  </div>
  <div id="subjectList" style="margin-top: 15px;"></div>
</div>

<!-- GROUPS -->
<div class="box">
  <h2>2) University Groups</h2>
  <div class="group-controls">
    <button onclick="addGroup()">‚ûï Add New Group</button>
    <select id="groupSelector" onchange="selectGroup(this.value)" style="padding: 10px; min-width: 200px;">
      <option value="">Select Group to Edit</option>
    </select>
  </div>
  
  <div id="currentGroupInfo" style="display: none; margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 8px;">
    <h3 style="margin: 0; color: #2c3e50;">Editing: <span id="groupNameDisplay" style="color: #3498db;"></span></h3>
    <div class="group-management">
      <button class="edit-btn" onclick="openEditGroupModal()" style="padding: 8px 15px; font-size: 14px;">‚úèÔ∏è Edit Group</button>
      <button class="remove-btn" onclick="deleteCurrentGroup()" style="padding: 8px 15px; font-size: 14px;">üóëÔ∏è Delete Group</button>
    </div>
  </div>
  
  <div id="groupScheduleEditor" style="display: none;">
    <!-- Class Form -->
    <div class="class-form">
      <div class="form-group">
        <label>Subject:</label>
        <select id="classSubject">
          <option value="">Select Subject</option>
        </select>
      </div>
      <div class="form-group">
        <label>Type:</label>
        <select id="classType">
          <option value="Lecture">Lecture</option>
          <option value="Section">Section</option>
          <option value="Lab">Lab</option>
        </select>
      </div>
      <div class="form-group">
        <label>Instructor Name:</label>
        <input id="className" placeholder="Enter name">
      </div>
      <div class="form-group">
        <label>Day:</label>
        <select id="classDay">
          <option value="Saturday">Saturday</option>
          <option value="Sunday">Sunday</option>
          <option value="Monday">Monday</option>
          <option value="Tuesday">Tuesday</option>
          <option value="Wednesday">Wednesday</option>
          <option value="Thursday">Thursday</option>
          <option value="Friday">Friday</option>
        </select>
      </div>
      <div class="form-group">
        <label>Time Slot:</label>
        <select id="classTime">
          <option value="0">Lecture 1 (8:30 AM - 10:00 AM)</option>
          <option value="1">Lecture 2 (10:30 AM - 12:00 PM)</option>
          <option value="2">Lecture 3 (12:30 PM - 2:00 PM)</option>
          <option value="3">Lecture 4 (2:30 PM - 4:00 PM)</option>
          <option value="4">Lecture 5 (4:30 PM - 6:00 PM)</option>
          <option value="5">Lecture 6 (6:30 PM - 8:00 PM)</option>
        </select>
      </div>
      <div class="form-group" style="justify-content: flex-end;">
        <button onclick="addClassToGroup()" style="height: 40px; margin-top: 25px;">Add to Schedule</button>
      </div>
    </div>
    
    <!-- Schedule Table -->
    <div class="schedule-table-container">
      <table class="schedule-table">
        <thead>
          <tr>
            <th class="day-header">Day</th>
            <th class="time-header">Lecture 1<br><small>8:30-10:00</small></th>
            <th class="time-header">Lecture 2<br><small>10:30-12:00</small></th>
            <th class="time-header">Lecture 3<br><small>12:30-2:00</small></th>
            <th class="time-header">Lecture 4<br><small>2:30-4:00</small></th>
            <th class="time-header">Lecture 5<br><small>4:30-6:00</small></th>
            <th class="time-header">Lecture 6<br><small>6:30-8:00</small></th>
          </tr>
        </thead>
        <tbody id="scheduleGrid">
          <!-- Days will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- PREFERENCES -->
<div class="box">
  <h2>3) Doctor / TA Preferences</h2>
  <div style="margin-bottom: 15px; padding: 10px; background: #e8f4fc; border-radius: 5px;">
    <p style="margin: 0; font-size: 14px; color: #2c3e50;">
      <strong>Note:</strong> Check the subjects you will take this semester. Unchecked subjects will be excluded from schedule generation.
    </p>
  </div>
  <div id="preferences"></div>
</div>

<!-- GENERATE -->
<div class="box">
  <h2>4) Generate Schedule</h2>
  <button onclick="generateSchedules()" style="padding: 12px 25px; font-size: 16px;">Generate All Possible Schedules</button>
  
  <div id="results" style="margin-top: 30px;">
    <div id="scheduleResults"></div>
  </div>
</div>

<script>
let subjects = [];
let groups = [];
let currentEditingGroup = null;
let allSchedules = [];

// Better color palette - easy on eyes with good contrast
const colorPalette = [
  { name: "Blue", light: '#D6EAF8', dark: '#3498DB' },
  { name: "Green", light: '#D5F4E6', dark: '#2ECC71' },
  { name: "Purple", light: '#E8DAEF', dark: '#9B59B6' },
  { name: "Orange", light: '#FDEBD0', dark: '#E67E22' },
  { name: "Red", light: '#FADBD8', dark: '#E74C3C' },
  { name: "Teal", light: '#D1F2EB', dark: '#1ABC9C' },
  { name: "Navy", light: '#D6DBDF', dark: '#2C3E50' },
  { name: "Pink", light: '#FAD7E0', dark: '#F06292' },
  { name: "Lime", light: '#E8F8F5', dark: '#58D68D' },
  { name: "Amber", light: '#FFF3CD', dark: '#FFA726' }
];

// Fixed lecture times
const lectureTimes = [
  { label: "Lecture 1", start: 8.5, end: 10, timeStr: "8:30 AM - 10:00 AM" },
  { label: "Lecture 2", start: 10.5, end: 12, timeStr: "10:30 AM - 12:00 PM" },
  { label: "Lecture 3", start: 12.5, end: 14, timeStr: "12:30 PM - 2:00 PM" },
  { label: "Lecture 4", start: 14.5, end: 16, timeStr: "2:30 PM - 4:00 PM" },
  { label: "Lecture 5", start: 16.5, end: 18, timeStr: "4:30 PM - 6:00 PM" },
  { label: "Lecture 6", start: 18.5, end: 20, timeStr: "6:30 PM - 8:00 PM" }
];

const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

// Variables for editing
let currentEditingClass = null;
let currentEditingSubject = null;
let currentEditingGroupIndex = null;

/******** BACKWARD COMPATIBILITY FUNCTIONS ********/
function convertOldFormatToNew(data) {
  console.log("Converting old format to new format...");
  
  // Check if subjects are strings (old format)
  if (data.subjects && data.subjects.length > 0 && typeof data.subjects[0] === 'string') {
    console.log("Detected old format: subjects as strings");
    
    // Convert subjects array of strings to array of objects
    data.subjects = data.subjects.map((subjectName, index) => {
      const colorIndex = index % colorPalette.length;
      return {
        name: subjectName,
        color: colorPalette[colorIndex],
        selected: true
      };
    });
  }
  
  // Make sure groups have proper structure
  if (data.groups && data.groups.length > 0) {
    data.groups.forEach(group => {
      // Ensure group has id and name
      if (!group.id) group.id = groups.length + 1;
      if (!group.name) group.name = `Group ${group.id}`;
      
      // Ensure each class has groupName
      if (group.classes && group.classes.length > 0) {
        group.classes.forEach(cls => {
          if (!cls.groupName) {
            cls.groupName = group.name;
          }
        });
      }
    });
  }
  
  // Ensure preferences have selected property
  if (data.preferences) {
    for (const subjectName in data.preferences) {
      if (typeof data.preferences[subjectName] === 'object') {
        data.preferences[subjectName].selected = true;
      }
    }
  }
  
  return data;
}

/******** SAVE/LOAD FUNCTIONALITY ********/
function showNotification(message, isError = false) {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = isError ? 'notification error' : 'notification';
  notification.style.display = 'block';
  
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

function saveToBrowser() {
  try {
    const data = {
      subjects: subjects,
      groups: groups,
      preferences: getCurrentPreferences(),
      timestamp: new Date().toISOString(),
      version: '2.0' // New version number
    };
    
    localStorage.setItem('universityScheduleData', JSON.stringify(data));
    showNotification('‚úÖ Data saved to browser successfully!');
  } catch (error) {
    showNotification('‚ùå Error saving data to browser', true);
  }
}

function loadFromBrowser() {
  try {
    const saved = localStorage.getItem('universityScheduleData');
    if (saved) {
      const data = JSON.parse(saved);
      
      // Check if data needs conversion from old format
      let processedData = data;
      if (!data.version || data.version === '1.0') {
        processedData = convertOldFormatToNew(data);
      }
      
      subjects = processedData.subjects || [];
      groups = processedData.groups || [];
      
      // Make sure all classes have groupName property
      groups.forEach(group => {
        group.classes.forEach(cls => {
          if (!cls.groupName) {
            cls.groupName = group.name;
          }
        });
      });
      
      // Ensure all subjects have the new structure
      subjects.forEach((subject, index) => {
        if (typeof subject === 'string') {
          const colorIndex = index % colorPalette.length;
          subjects[index] = {
            name: subject,
            color: colorPalette[colorIndex],
            selected: true
          };
        }
      });
      
      renderSubjects();
      updateClassSubjectDropdown();
      updateGroupSelector();
      renderPreferences();
      
      // Load preferences after rendering
      if (processedData.preferences) {
        setTimeout(() => loadPreferences(processedData.preferences), 100);
      }
      
      showNotification('üìÇ Data loaded from browser');
    }
  } catch (error) {
    console.error('Error loading from browser:', error);
    showNotification('‚ö†Ô∏è Error loading saved data. Starting fresh.', true);
  }
}

function getCurrentPreferences() {
  const preferences = {};
  subjects.forEach(subject => {
    const lectureElem = document.getElementById(`pref_${subject.name}_Lecture`);
    const sectionElem = document.getElementById(`pref_${subject.name}_Section`);
    const labElem = document.getElementById(`pref_${subject.name}_Lab`);
    const checkboxElem = document.getElementById(`check_${subject.name}`);
    
    if (lectureElem && sectionElem && labElem) {
      preferences[subject.name] = {
        Lecture: lectureElem.value,
        Section: sectionElem.value,
        Lab: labElem.value,
        selected: checkboxElem ? checkboxElem.checked : true
      };
    }
  });
  return preferences;
}

function loadPreferences(preferences) {
  for (const subjectName in preferences) {
    const lectureElem = document.getElementById(`pref_${subjectName}_Lecture`);
    const sectionElem = document.getElementById(`pref_${subjectName}_Section`);
    const labElem = document.getElementById(`pref_${subjectName}_Lab`);
    const checkboxElem = document.getElementById(`check_${subjectName}`);
    
    if (lectureElem) lectureElem.value = preferences[subjectName].Lecture || 'Any';
    if (sectionElem) sectionElem.value = preferences[subjectName].Section || 'Any';
    if (labElem) labElem.value = preferences[subjectName].Lab || 'Any';
    if (checkboxElem) checkboxElem.checked = preferences[subjectName].selected !== false;
    
    // Update subject selected status
    const subject = subjects.find(s => s.name === subjectName);
    if (subject && preferences[subjectName].selected !== undefined) {
      subject.selected = preferences[subjectName].selected;
    }
  }
}

function exportData() {
  try {
    const data = {
      subjects: subjects,
      groups: groups,
      preferences: getCurrentPreferences(),
      timestamp: new Date().toISOString(),
      version: '2.0'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `university-schedule-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('üì§ Data exported successfully!');
  } catch (error) {
    showNotification('‚ùå Error exporting data', true);
  }
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      if (!data.subjects) {
        throw new Error('Invalid file format: No subjects found');
      }
      
      // Convert old format to new format if needed
      let processedData = data;
      if (!data.version || data.version === '1.0') {
        processedData = convertOldFormatToNew(data);
        showNotification('üîÑ Converted old format to new format');
      }
      
      subjects = processedData.subjects || [];
      groups = processedData.groups || [];
      
      // Ensure all subjects have the new structure
      subjects.forEach((subject, index) => {
        if (typeof subject === 'string') {
          const colorIndex = index % colorPalette.length;
          subjects[index] = {
            name: subject,
            color: colorPalette[colorIndex],
            selected: true
          };
        }
      });
      
      // Make sure all classes have groupName
      groups.forEach(group => {
        if (!group.classes) group.classes = [];
        group.classes.forEach(cls => {
          if (!cls.groupName) {
            cls.groupName = group.name;
          }
        });
      });
      
      // Reset file input
      event.target.value = '';
      
      renderSubjects();
      updateClassSubjectDropdown();
      updateGroupSelector();
      renderPreferences();
      
      // Load preferences after rendering
      if (processedData.preferences) {
        setTimeout(() => loadPreferences(processedData.preferences), 100);
      }
      
      if (currentEditingGroup) {
        renderScheduleTable(currentEditingGroup);
      }
      
      // Auto-save the converted data
      setTimeout(() => saveToBrowser(), 500);
      
      showNotification('üì• Data imported successfully!');
    } catch (error) {
      console.error('Import error:', error);
      showNotification('‚ùå Error importing data. Invalid file format.', true);
    }
  };
  reader.readAsText(file);
}

function resetAll() {
  if (!confirm('‚ö†Ô∏è Are you sure you want to reset everything? This action cannot be undone.')) {
    return;
  }
  
  subjects = [];
  groups = [];
  currentEditingGroup = null;
  allSchedules = [];
  
  // Clear local storage
  localStorage.removeItem('universityScheduleData');
  
  // Clear UI
  renderSubjects();
  updateClassSubjectDropdown();
  updateGroupSelector();
  renderPreferences();
  
  // Hide schedule editor
  document.getElementById('currentGroupInfo').style.display = 'none';
  document.getElementById('groupScheduleEditor').style.display = 'none';
  
  // Clear results
  document.getElementById('scheduleResults').innerHTML = '';
  document.getElementById('results').innerHTML = '<div id="scheduleResults"></div>';
  
  // Clear form fields
  document.getElementById('subjectName').value = '';
  document.getElementById('className').value = '';
  
  showNotification('üîÑ All data has been reset');
}

// Auto-save when making changes
function autoSave() {
  if (localStorage.getItem('universityScheduleData')) {
    saveToBrowser();
  }
}

/******** SUBJECTS MANAGEMENT ********/
function getSubjectColor(subjectName) {
  const subject = subjects.find(s => s.name === subjectName);
  if (subject && subject.color) {
    return subject.color;
  }
  
  // Default color if not found
  const index = subjects.findIndex(s => s.name === subjectName) % colorPalette.length;
  return colorPalette[index] || colorPalette[0];
}

function addSubject() {
  const name = document.getElementById('subjectName').value.trim();
  if (!name) {
    alert("Please enter a subject name");
    return;
  }
  if (subjects.some(s => s.name === name)) {
    alert("Subject already exists");
    return;
  }
  
  const colorIndex = subjects.length % colorPalette.length;
  const color = colorPalette[colorIndex];
  
  subjects.push({
    name: name,
    color: color,
    selected: true // Default to selected for schedule generation
  });
  
  document.getElementById('subjectName').value = '';
  renderSubjects();
  updateClassSubjectDropdown();
  renderPreferences();
  autoSave();
}

function editSubject(subjectName) {
  const subject = subjects.find(s => s.name === subjectName);
  if (!subject) return;
  
  currentEditingSubject = subjectName;
  const modal = document.getElementById('editSubjectModal');
  const modalBody = document.getElementById('editSubjectBody');
  
  modalBody.innerHTML = `
    <div style="margin-bottom: 20px;">
      <label>Subject Name:</label>
      <input type="text" id="editSubjectName" value="${subject.name}" 
             style="width: 100%; padding: 8px; background: white; color: #2c3e50;">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label>Choose Color:</label>
      <div class="color-picker">
        ${colorPalette.map((color, index) => `
          <div class="color-option ${subject.color.name === color.name ? 'selected' : ''}" 
               style="background: ${color.dark};" 
               onclick="selectColorForSubject(${index})"
               title="${color.name}"></div>
        `).join('')}
      </div>
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeEditSubjectModal()" style="background: #95a5a6;">Cancel</button>
      <button onclick="saveSubjectChanges()" style="background: #2ecc71;">Save Changes</button>
    </div>
  `;
  
  modal.style.display = 'block';
}

function selectColorForSubject(index) {
  document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
  document.querySelectorAll('.color-option')[index].classList.add('selected');
}

function saveSubjectChanges() {
  if (!currentEditingSubject) return;
  
  const newName = document.getElementById('editSubjectName').value.trim();
  if (!newName) {
    alert("Subject name cannot be empty");
    return;
  }
  
  // Check if new name already exists (excluding the current subject)
  if (newName !== currentEditingSubject && subjects.some(s => s.name === newName)) {
    alert("Subject name already exists");
    return;
  }
  
  const selectedColorOption = document.querySelector('.color-option.selected');
  const colorIndex = Array.from(document.querySelectorAll('.color-option')).indexOf(selectedColorOption);
  const newColor = colorPalette[colorIndex] || colorPalette[0];
  
  // Update subject
  const subjectIndex = subjects.findIndex(s => s.name === currentEditingSubject);
  if (subjectIndex !== -1) {
    // Update all classes with the old subject name
    groups.forEach(group => {
      group.classes.forEach(cls => {
        if (cls.subject === currentEditingSubject) {
          cls.subject = newName;
        }
      });
    });
    
    // Update subject itself
    subjects[subjectIndex] = {
      name: newName,
      color: newColor,
      selected: subjects[subjectIndex].selected
    };
  }
  
  closeEditSubjectModal();
  renderSubjects();
  updateClassSubjectDropdown();
  renderPreferences();
  if (currentEditingGroup) {
    renderScheduleTable(currentEditingGroup);
  }
  autoSave();
  showNotification('‚úÖ Subject updated!');
}

function closeEditSubjectModal() {
  document.getElementById('editSubjectModal').style.display = 'none';
  currentEditingSubject = null;
}

function removeSubject(subjectName) {
  if (!confirm(`Remove subject "${subjectName}"? This will also remove all classes for this subject.`)) return;
  
  subjects = subjects.filter(s => s.name !== subjectName);
  groups.forEach(g => {
    g.classes = g.classes.filter(c => c.subject !== subjectName);
  });
  renderSubjects();
  updateClassSubjectDropdown();
  renderPreferences();
  if (currentEditingGroup) {
    renderScheduleTable(currentEditingGroup);
  }
  autoSave();
}

function renderSubjects() {
  const container = document.getElementById('subjectList');
  container.innerHTML = '';
  
  if (subjects.length === 0) {
    container.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">No subjects added yet.</p>';
    return;
  }
  
  subjects.forEach(subject => {
    const color = subject.color;
    const div = document.createElement('div');
    div.className = 'subject-item';
    div.style.background = color.light;
    div.style.borderLeftColor = color.dark;
    div.innerHTML = `
      <span style="font-weight:600; color:${color.dark};">${subject.name}</span>
      <div>
        <button class="edit-btn" onclick="editSubject('${subject.name}')">‚úèÔ∏è Edit</button>
        <button class="remove-btn" onclick="removeSubject('${subject.name}')">Remove</button>
      </div>
    `;
    container.appendChild(div);
  });
}

/******** GROUPS MANAGEMENT ********/
function addGroup() {
  const groupId = groups.length + 1;
  const groupName = `Group ${groupId}`;
  
  groups.push({
    id: groupId,
    name: groupName,
    classes: []
  });
  
  updateGroupSelector();
  selectGroup(groups.length - 1);
  autoSave();
}

function updateGroupSelector() {
  const selector = document.getElementById('groupSelector');
  selector.innerHTML = '<option value="">Select Group to Edit</option>';
  
  groups.forEach((g, i) => {
    selector.innerHTML += `<option value="${i}">${g.name}</option>`;
  });
}

function selectGroup(index) {
  if (index === "") {
    document.getElementById('currentGroupInfo').style.display = 'none';
    document.getElementById('groupScheduleEditor').style.display = 'none';
    currentEditingGroup = null;
    return;
  }
  
  currentEditingGroup = groups[index];
  document.getElementById('currentGroupInfo').style.display = 'block';
  document.getElementById('groupScheduleEditor').style.display = 'block';
  document.getElementById('groupNameDisplay').textContent = currentEditingGroup.name;
  
  renderScheduleTable(currentEditingGroup);
}

function openEditGroupModal() {
  if (!currentEditingGroup) return;
  
  currentEditingGroupIndex = groups.indexOf(currentEditingGroup);
  const modal = document.getElementById('editGroupModal');
  const modalBody = document.getElementById('editGroupBody');
  
  modalBody.innerHTML = `
    <div style="margin-bottom: 20px;">
      <label>Group Name:</label>
      <input type="text" id="editGroupName" value="${currentEditingGroup.name}" 
             style="width: 100%; padding: 8px; background: white; color: #2c3e50;">
    </div>
    
    <div style="margin-bottom: 20px; color: #e74c3c; font-size: 14px;">
      <strong>Warning:</strong> Changing the group name will update all classes in this group.
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeEditGroupModal()" style="background: #95a5a6;">Cancel</button>
      <button onclick="saveGroupChanges()" style="background: #2ecc71;">Save Changes</button>
    </div>
  `;
  
  modal.style.display = 'block';
}

function saveGroupChanges() {
  if (currentEditingGroupIndex === null || !currentEditingGroup) return;
  
  const newName = document.getElementById('editGroupName').value.trim();
  if (!newName) {
    alert("Group name cannot be empty");
    return;
  }
  
  // Check if new name already exists (excluding current group)
  if (newName !== currentEditingGroup.name && groups.some(g => g.name === newName)) {
    alert("Group name already exists");
    return;
  }
  
  const oldName = currentEditingGroup.name;
  currentEditingGroup.name = newName;
  
  // Update all classes in this group
  currentEditingGroup.classes.forEach(cls => {
    cls.groupName = newName;
  });
  
  closeEditGroupModal();
  updateGroupSelector();
  document.getElementById('groupNameDisplay').textContent = newName;
  if (currentEditingGroup) {
    renderScheduleTable(currentEditingGroup);
  }
  autoSave();
  showNotification('‚úÖ Group updated!');
}

function closeEditGroupModal() {
  document.getElementById('editGroupModal').style.display = 'none';
  currentEditingGroupIndex = null;
}

function deleteCurrentGroup() {
  if (!currentEditingGroup) return;
  
  if (!confirm(`Delete group "${currentEditingGroup.name}"? This will remove all classes in this group.`)) {
    return;
  }
  
  const groupIndex = groups.indexOf(currentEditingGroup);
  groups.splice(groupIndex, 1);
  
  currentEditingGroup = null;
  updateGroupSelector();
  document.getElementById('currentGroupInfo').style.display = 'none';
  document.getElementById('groupScheduleEditor').style.display = 'none';
  renderPreferences();
  autoSave();
  showNotification('‚úÖ Group deleted!');
}

function updateClassSubjectDropdown() {
  const dropdown = document.getElementById('classSubject');
  dropdown.innerHTML = '<option value="">Select Subject</option>';
  
  subjects.forEach(s => {
    dropdown.innerHTML += `<option value="${s.name}">${s.name}</option>`;
  });
}

function addClassToGroup() {
  if (!currentEditingGroup) {
    alert("Please select a group first");
    return;
  }
  
  const subject = document.getElementById('classSubject').value;
  const type = document.getElementById('classType').value;
  let name = document.getElementById('className').value.trim();
  const day = document.getElementById('classDay').value;
  const timeSlot = parseInt(document.getElementById('classTime').value);
  
  if (!subject) {
    alert("Please select a subject");
    return;
  }
  
  const timeData = lectureTimes[timeSlot];
  const startTime = timeData.start * 60;
  const endTime = timeData.end * 60;
  
  // Check for time conflicts
  const conflict = currentEditingGroup.classes.find(c => 
    c.day === day && 
    c.timeSlot === timeSlot
  );
  
  if (conflict) {
    if (!confirm(`There's already a class in this time slot. Replace it?`)) return;
    currentEditingGroup.classes = currentEditingGroup.classes.filter(c => 
      !(c.day === day && c.timeSlot === timeSlot)
    );
  }
  
  currentEditingGroup.classes.push({
    subject,
    type,
    name: name || '', // Allow empty name
    day,
    timeSlot,
    start: startTime,
    end: endTime,
    groupName: currentEditingGroup.name  // Store group name with the class
  });
  
  // Clear form
  document.getElementById('className').value = '';
  
  renderScheduleTable(currentEditingGroup);
  renderPreferences();
  autoSave();
}

function removeClassFromGroup(day, timeSlot) {
  if (!currentEditingGroup) return;
  
  currentEditingGroup.classes = currentEditingGroup.classes.filter(c => 
    !(c.day === day && c.timeSlot === timeSlot)
  );
  
  renderScheduleTable(currentEditingGroup);
  renderPreferences();
  autoSave();
}

function openEditModal(day, timeSlot) {
  if (!currentEditingGroup) return;
  
  const classItem = currentEditingGroup.classes.find(c => 
    c.day === day && c.timeSlot === timeSlot
  );
  
  if (!classItem) return;
  
  currentEditingClass = { day, timeSlot, groupIndex: groups.indexOf(currentEditingGroup) };
  
  const modal = document.getElementById('editInstructorModal');
  const modalBody = document.getElementById('modalBody');
  
  modalBody.innerHTML = `
    <div style="margin-bottom: 20px;">
      <div><strong>Subject:</strong> ${classItem.subject}</div>
      <div><strong>Type:</strong> ${classItem.type}</div>
      <div><strong>Day:</strong> ${classItem.day}</div>
      <div><strong>Time:</strong> ${lectureTimes[classItem.timeSlot].timeStr}</div>
      <div><strong>Group:</strong> ${currentEditingGroup.name}</div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <label>Instructor Name:</label>
      <input type="text" id="editInstructorName" value="${classItem.name || ''}" 
             placeholder="Enter name" style="width: 100%; padding: 8px; background: white; color: #2c3e50;">
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeEditModal()" style="background: #95a5a6;">Cancel</button>
      <button onclick="saveInstructorName()" style="background: #2ecc71;">Save</button>
    </div>
  `;
  
  modal.style.display = 'block';
}

function closeEditModal() {
  document.getElementById('editInstructorModal').style.display = 'none';
  currentEditingClass = null;
}

function saveInstructorName() {
  if (!currentEditingClass) return;
  
  const newName = document.getElementById('editInstructorName').value.trim();
  const { day, timeSlot, groupIndex } = currentEditingClass;
  
  if (groupIndex >= 0 && groupIndex < groups.length) {
    const group = groups[groupIndex];
    const classItem = group.classes.find(c => 
      c.day === day && c.timeSlot === timeSlot
    );
    
    if (classItem) {
      classItem.name = newName;
      
      // If we're currently editing this group, update the table
      if (currentEditingGroup && currentEditingGroup.id === group.id) {
        renderScheduleTable(currentEditingGroup);
      }
      
      renderPreferences();
      autoSave();
      closeEditModal();
      showNotification('‚úÖ Instructor name updated!');
    }
  }
}

function renderScheduleTable(group) {
  const tbody = document.getElementById('scheduleGrid');
  tbody.innerHTML = '';
  
  // Create rows for each day
  days.forEach(day => {
    const row = document.createElement('tr');
    
    // Day cell - first column
    const dayCell = document.createElement('td');
    dayCell.className = 'day-header';
    dayCell.textContent = day;
    dayCell.style.fontWeight = '600';
    row.appendChild(dayCell);
    
    // Create cells for each lecture slot (6 columns)
    for (let timeIndex = 0; timeIndex < 6; timeIndex++) {
      const cell = document.createElement('td');
      cell.className = 'empty-cell';
      
      // Find class for this day and time slot
      const classItem = group.classes.find(c => 
        c.day === day && c.timeSlot === timeIndex
      );
      
      if (classItem) {
        const subjectData = subjects.find(s => s.name === classItem.subject);
        const color = subjectData ? subjectData.color : colorPalette[0];
        
        const hasInstructor = classItem.name && classItem.name.trim() !== '';
        
        const classBox = document.createElement('div');
        classBox.className = 'class-box';
        classBox.style.background = color.light;
        classBox.style.borderLeft = `3px solid ${color.dark}`;
        classBox.innerHTML = `
          <div class="class-subject" style="background:${color.dark}; color:white;">${classItem.subject}</div>
          ${hasInstructor ? 
            `<div class="class-doctor" style="color:${color.dark};">${classItem.name}</div>` : 
            `<div class="no-instructor">Instructor not assigned</div>`
          }
          <div class="class-type" style="background:${color.dark}; color:white;">${classItem.type}</div>
          <button class="edit-class-btn" onclick="event.stopPropagation(); openEditModal('${day}', ${timeIndex})">
            ‚úèÔ∏è Edit
          </button>
          <button class="remove-btn" onclick="removeClassFromGroup('${day}', ${timeIndex})" 
                  style="position:absolute; top:5px; right:5px; padding:2px 6px; font-size:10px;">‚úï</button>
        `;
        cell.appendChild(classBox);
      }
      
      row.appendChild(cell);
    }
    
    tbody.appendChild(row);
  });
}

/******** PREFERENCES ********/
function renderPreferences() {
  const div = document.getElementById('preferences');
  div.innerHTML = '';
  
  if (subjects.length === 0) {
    div.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">Add subjects first to set preferences.</p>';
    return;
  }
  
  subjects.forEach(subject => {
    // Collect names separately by type for this subject
    const lectureNames = new Set();
    const sectionNames = new Set();
    const labNames = new Set();
    
    groups.forEach(g => {
      g.classes.filter(c => c.subject === subject.name && c.name && c.name.trim() !== '').forEach(c => {
        if (c.type === 'Lecture') {
          lectureNames.add(c.name);
        } else if (c.type === 'Section') {
          sectionNames.add(c.name);
        } else if (c.type === 'Lab') {
          labNames.add(c.name);
        }
      });
    });
    
    const color = subject.color;
    
    const prefBox = document.createElement('div');
    prefBox.className = 'preference-box';
    prefBox.style.borderLeft = `4px solid ${color.dark}`;
    prefBox.style.background = color.light;
    prefBox.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h4 style="margin: 0; color:${color.dark};">
          ${subject.name}
        </h4>
        <div>
          <input type="checkbox" id="check_${subject.name}" class="subject-checkbox" 
                 ${subject.selected !== false ? 'checked' : ''} 
                 onchange="updateSubjectSelection('${subject.name}')">
          <label for="check_${subject.name}" style="font-size: 12px; color: #7f8c8d; margin-left: 5px;">
            Include in schedule
          </label>
        </div>
      </div>
      <div class="pref-type-container">
        <div class="pref-type">
          <label>Preferred Lecture Doctor:</label>
          <select id="pref_${subject.name}_Lecture" style="width:100%" onchange="autoSave()">
            <option value="Any">Any doctor</option>
            ${Array.from(lectureNames).map(n => `<option value="${n}">Dr. ${n}</option>`).join('')}
          </select>
          <div style="font-size:11px; color:#7f8c8d; margin-top:5px;">
            ${lectureNames.size} doctor${lectureNames.size !== 1 ? 's' : ''} available
          </div>
        </div>
        <div class="pref-type">
          <label>Preferred Section TA:</label>
          <select id="pref_${subject.name}_Section" style="width:100%" onchange="autoSave()">
            <option value="Any">Any TA</option>
            ${Array.from(sectionNames).map(n => `<option value="${n}">TA ${n}</option>`).join('')}
          </select>
          <div style="font-size:11px; color:#7f8c8d; margin-top:5px;">
            ${sectionNames.size} TA${sectionNames.size !== 1 ? 's' : ''} available
          </div>
        </div>
        <div class="pref-type">
          <label>Preferred Lab TA:</label>
          <select id="pref_${subject.name}_Lab" style="width:100%" onchange="autoSave()">
            <option value="Any">Any TA</option>
            ${Array.from(labNames).map(n => `<option value="${n}">TA ${n}</option>`).join('')}
          </select>
          <div style="font-size:11px; color:#7f8c8d; margin-top:5px;">
            ${labNames.size} TA${labNames.size !== 1 ? 's' : ''} available
          </div>
        </div>
      </div>
    `;
    div.appendChild(prefBox);
  });
}

function updateSubjectSelection(subjectName) {
  const checkbox = document.getElementById(`check_${subjectName}`);
  const subject = subjects.find(s => s.name === subjectName);
  if (subject) {
    subject.selected = checkbox.checked;
    autoSave();
  }
}

/******** SCHEDULE GENERATION ********/
function toMin(t) { 
  if (!t) return 0; 
  if (typeof t === 'number') return t;
  let [h, m] = t.split(':'); 
  return parseInt(h) * 60 + parseInt(m || 0); 
}

function fromMin(m) { 
  const hours = Math.floor(m / 60);
  const minutes = m % 60;
  const ampm = hours >= 12 ? 'PM' : 'AM';
  const displayHours = hours % 12 || 12;
  return `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
}

function clash(a, b) { 
  return a.day === b.day && !(a.end <= b.start || b.end <= a.start); 
}

function generateSchedules() {
  // Get only selected subjects
  const selectedSubjects = subjects.filter(s => s.selected !== false).map(s => s.name);
  
  if (selectedSubjects.length === 0) {
    alert("Please select at least one subject to include in schedule generation.");
    return;
  }
  
  if (groups.length === 0) {
    alert("Please add at least one group");
    return;
  }
  
  // Collect all possible class combinations per selected subject
  let options = {};
  selectedSubjects.forEach(s => options[s] = []);
  
  groups.forEach(g => {
    selectedSubjects.forEach(s => {
      let pack = g.classes.filter(c => c.subject === s);
      if (!pack.length) return;
      
      let ok = true;
      pack.forEach(c => {
        let pref = document.getElementById(`pref_${s}_${c.type}`)?.value || 'Any';
        if (pref !== 'Any' && pref !== c.name) ok = false;
      });
      if (ok) options[s].push({pack: pack, group: g.name});
    });
  });
  
  // Check if any subject has no options
  const subjectsWithNoOptions = [];
  for (let subject in options) {
    if (options[subject].length === 0) {
      subjectsWithNoOptions.push(subject);
    }
  }
  
  if (subjectsWithNoOptions.length > 0) {
    alert(`No valid classes found for "${subjectsWithNoOptions.join(', ')}" based on preferences.`);
    return;
  }
  
  allSchedules = [];
  let subjectList = Object.keys(options);
  
  function backtrack(index, current, groupsUsed) {
    if (index === subjectList.length) {
      allSchedules.push({
        classes: current.flat(),
        groups: [...groupsUsed]
      });
      return;
    }
    
    const subject = subjectList[index];
    for (let option of options[subject]) {
      let valid = true;
      
      // Check for time conflicts
      for (let newClass of option.pack) {
        for (let existingClass of current.flat()) {
          if (clash(newClass, existingClass)) {
            valid = false;
            break;
          }
        }
        if (!valid) break;
      }
      
      if (valid) {
        // Add group name to each class in the pack
        const packWithGroup = option.pack.map(cls => ({
          ...cls,
          groupName: option.group
        }));
        
        backtrack(index + 1, [...current, packWithGroup], [...groupsUsed, option.group]);
      }
    }
  }
  
  backtrack(0, [], []);
  displayAllSchedules();
}

function displayAllSchedules() {
  const resultsDiv = document.getElementById('results');
  const scheduleResults = document.getElementById('scheduleResults');
  
  if (!allSchedules.length) {
    scheduleResults.innerHTML = `
      <div class="box" style="text-align:center; padding:30px;">
        <h3 style="color:#e74c3c;">No Valid Schedules Found</h3>
        <p>Try adjusting your preferences or adding more classes to groups.</p>
      </div>
    `;
    return;
  }
  
  scheduleResults.innerHTML = '';
  
  // Show all schedules stacked
  allSchedules.forEach((scheduleData, index) => {
    const schedule = scheduleData.classes;
    const scheduleDiv = document.createElement('div');
    scheduleDiv.className = 'result-schedule';
    scheduleDiv.id = `schedule-${index}`;
    
    // Get unique groups used in this schedule
    const uniqueGroups = [...new Set(schedule.map(c => c.groupName))];
    
    // Count classes without instructors
    const classesWithoutInstructors = schedule.filter(c => !c.name || c.name.trim() === '').length;
    
    const scheduleTitle = document.createElement('h3');
    scheduleTitle.innerHTML = `
      Schedule Option ${index + 1} 
      <small style="color:#7f8c8d; font-weight:normal;">
        (${schedule.length} classes from ${uniqueGroups.length} group${uniqueGroups.length !== 1 ? 's' : ''})
        ${classesWithoutInstructors > 0 ? `<span style="color:#e74c3c;">‚Ä¢ ${classesWithoutInstructors} without instructor</span>` : ''}
      </small>
    `;
    scheduleDiv.appendChild(scheduleTitle);
    
    // Create table for this schedule
    const tableContainer = document.createElement('div');
    tableContainer.className = 'schedule-table-container';
    
    const table = document.createElement('table');
    table.className = 'schedule-table';
    
    // Table header (simplified - no "Lectures" row)
    table.innerHTML = `
      <thead>
        <tr>
          <th class="day-header">Day</th>
          <th class="time-header">Lecture 1<br><small>8:30-10:00</small></th>
          <th class="time-header">Lecture 2<br><small>10:30-12:00</small></th>
          <th class="time-header">Lecture 3<br><small>12:30-2:00</small></th>
          <th class="time-header">Lecture 4<br><small>2:30-4:00</small></th>
          <th class="time-header">Lecture 5<br><small>4:30-6:00</small></th>
          <th class="time-header">Lecture 6<br><small>6:30-8:00</small></th>
        </tr>
      </thead>
      <tbody id="result-schedule-${index}">
      </tbody>
    `;
    
    const tbody = table.querySelector(`#result-schedule-${index}`);
    
    // Group classes by day
    const classesByDay = {};
    days.forEach(day => classesByDay[day] = Array(6).fill(null));
    
    schedule.forEach(cls => {
      classesByDay[cls.day][cls.timeSlot] = cls;
    });
    
    // Create rows for each day
    days.forEach(day => {
      const row = document.createElement('tr');
      
      // Day cell - first column
      const dayCell = document.createElement('td');
      dayCell.className = 'day-header';
      dayCell.textContent = day;
      dayCell.style.fontWeight = '600';
      row.appendChild(dayCell);
      
      // Cells for each lecture slot
      for (let i = 0; i < 6; i++) {
        const cell = document.createElement('td');
        cell.className = 'empty-cell';
        
        const cls = classesByDay[day][i];
        if (cls) {
          const subjectData = subjects.find(s => s.name === cls.subject);
          const color = subjectData ? subjectData.color : colorPalette[0];
          
          const hasInstructor = cls.name && cls.name.trim() !== '';
          
          const classBox = document.createElement('div');
          classBox.className = 'class-box';
          classBox.style.background = color.light;
          classBox.style.borderLeft = `3px solid ${color.dark}`;
          classBox.innerHTML = `
            <div class="class-subject" style="background:${color.dark}; color:white;">${cls.subject}</div>
            ${hasInstructor ? 
              `<div class="class-doctor" style="color:${color.dark};">${cls.name}</div>` : 
              `<div class="no-instructor">Instructor not assigned</div>`
            }
            <div class="class-type" style="background:${color.dark}; color:white;">${cls.type}</div>
            <div class="class-group" style="color:${color.dark};">${cls.groupName}</div>
            <div style="font-size:10px; color:${color.dark}; margin-top:3px;">${fromMin(cls.start)}-${fromMin(cls.end)}</div>
          `;
          cell.appendChild(classBox);
        }
        
        row.appendChild(cell);
      }
      
      tbody.appendChild(row);
    });
    
    tableContainer.appendChild(table);
    scheduleDiv.appendChild(tableContainer);
    scheduleResults.appendChild(scheduleDiv);
  });
  
  // Add summary
  const selectedCount = subjects.filter(s => s.selected !== false).length;
  const totalCount = subjects.length;
  
  const summary = document.createElement('div');
  summary.className = 'box';
  summary.style.textAlign = 'center';
  summary.innerHTML = `
    <h3 style="color:#27ae60;">Found ${allSchedules.length} Possible Schedule${allSchedules.length !== 1 ? 's' : ''}</h3>
    <p>Generated from ${selectedCount} of ${totalCount} selected subjects.</p>
    <p>Each class shows which group it belongs to (e.g., "Group 1"). This helps you know which group to register for.</p>
    <p>Scroll down to see all schedule options stacked below.</p>
  `;
  scheduleResults.insertBefore(summary, scheduleResults.firstChild);
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modals = ['editInstructorModal', 'editSubjectModal', 'editGroupModal'];
  modals.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (event.target == modal) {
      if (modalId === 'editInstructorModal') closeEditModal();
      if (modalId === 'editSubjectModal') closeEditSubjectModal();
      if (modalId === 'editGroupModal') closeEditGroupModal();
    }
  });
}

// Load data from browser when page loads
window.addEventListener('load', () => {
  loadFromBrowser();
});

// Initialize
updateClassSubjectDropdown();
renderSubjects();
</script>

</body>
</html>
